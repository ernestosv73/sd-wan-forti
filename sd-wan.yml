name: forti-sdwan

topology:
  nodes:
    # FortiGates - Dispositivos SD-WAN
    fgt-branch:
      kind: fortinet_fortigate
      image: vrnetlab/vr-fortios:6.4.1
      env:
        QEMU_SMP: 1
        QEMU_MEMORY: 1024
      ports:
        - 80:80
        - 443:443
      mgmt-ipv4: 172.20.20.21

    fgt-datacenter:
      kind: fortinet_fortigate
      image: vrnetlab/vr-fortios:6.4.1
      env:
        QEMU_SMP: 1
        QEMU_MEMORY: 1024
      ports:
        - 8080:80
        - 4443:443
      mgmt-ipv4: 172.20.20.22

    # Nodos que simulan los ISPs (Solo proveen conectividad underlay)
    isp1:
      kind: linux
      image: bprodoehl/wan-emulator:20230418
      mgmt-ipv4: 172.20.20.11
      binds:
        - configs/crea-bridge.sh:/root/crea-bridge.sh
      exec:
        - chmod +x /root/crea-bridge.sh
        - bash /root/crea-bridge.sh    
      
    isp2:
      kind: linux
      image: bprodoehl/wan-emulator:20230418
      mgmt-ipv4: 172.20.20.12
      binds:
        - configs/crea-bridge.sh:/root/crea-bridge.sh
      exec:
        - chmod +x /root/crea-bridge.sh
        - bash /root/crea-bridge.sh    
      

    # Servidores y Clientes de Simulación
    server-dc:
      kind: linux
      image: docker.io/esanchezv/srvhttps:latest
      mgmt-ipv4: 172.20.20.100
      exec:
       - ip addr add 192.168.2.100/24 dev eth1
       - ip route del default dev eth0
       - ip route add default via 192.168.2.1

    pc-branch:
      kind: linux
      image: docker.io/esanchezv/kaliipv6:latest
      mgmt-ipv4: 172.20.20.101
      exec:
       - ip addr add 192.168.1.10/24 dev eth1
       - ip route del default dev eth0
       - ip route add default via 192.168.1.1
      

  links:
    # -----------------------------------------------
    # CONEXIONES UNDERLAY (REDES WAN/INTERNET)
    # -----------------------------------------------
    
    # Sucursal: Conexiones a los ISPs
    - endpoints: ["fgt-branch:eth1", "isp1:eth1"]  # Enlace Principal (Fibra)
    - endpoints: ["fgt-branch:eth2", "isp2:eth1"]  # Enlace de Backup (4G/5G)

    # Data Center: Conexión a los ISPs
    - endpoints: ["fgt-datacenter:eth1", "isp1:eth2"]
    - endpoints: ["fgt-datacenter:eth2", "isp2:eth2"]  # Enlace de Backup (4G/5G)

    # -----------------------------------------------
    # CONEXIONES OVERLAY (REDES LAN PRIVADAS)
    # -----------------------------------------------
    
    # Red LAN de la Sucursal
    - endpoints: ["fgt-branch:eth3", "pc-branch:eth1"]

    # Red LAN del Data Center
    - endpoints: ["fgt-datacenter:eth3", "server-dc:eth1"]
