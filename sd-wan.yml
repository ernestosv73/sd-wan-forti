name: forti-sdwan

topology:
  nodes:
    # FortiGates - Dispositivos SD-WAN
    fgt-branch:
      kind: fortinet_fortigate
      image: vrnetlab/vr-fortios:6.0.3
      env:
        QEMU_SMP: 1
        QEMU_MEMORY: 1024
      ports:
        - 80:80
        - 443:443
      mgmt-ipv4: 172.20.20.21

    fgt-datacenter:
      kind: fortinet_fortigate
      image: vrnetlab/vr-fortios:6.0.3
      env:
        QEMU_SMP: 1
        QEMU_MEMORY: 1024
      ports:
        - 8080:80
        - 4443:443
      mgmt-ipv4: 172.20.20.22

    # Nodos que simulan los ISPs (Solo proveen conectividad underlay)
    isp1:
      kind: linux
      image: docker.io/esanchezv/srvhttps:latest
      mgmt-ipv4: 172.20.20.11
      cmd: "/bin/sh -c 'echo \"net.ipv4.ip_forward=1\" >> /etc/sysctl.conf && sysctl -p && sleep infinity'"
      exec:
       - ip addr add 203.0.113.1/30 dev eth1
       - ip addr add 203.0.113.5/30 dev eth2
       - ip route add 192.168.1.0/24 via 203.0.113.2
       - ip route add 10.10.10.0/24 via 203.0.113.6
       - ip route del default dev eth0
       - "sysctl -w net.ipv4.ip_forward=1"

    isp2:
      kind: linux
      image: docker.io/esanchezv/srvhttps:latest
      mgmt-ipv4: 172.20.20.12
      cmd: "/bin/sh -c 'echo \"net.ipv4.ip_forward=1\" >> /etc/sysctl.conf && sysctl -p && sleep infinity'"
      exec:
       - ip addr add 198.51.100.1/30 dev eth1
       - ip addr add 198.51.100.5/30 dev eth2
       - "sysctl -w net.ipv4.ip_forward=1"

    # Servidores y Clientes de Simulación
    server-dc:
      kind: linux
      image: docker.io/esanchezv/srvhttps:latest
      mgmt-ipv4: 172.20.20.100
      exec:
       - ip addr add 10.10.10.100/24 dev eth1

    pc-branch:
      kind: linux
      image: docker.io/esanchezv/kaliipv6:latest
      mgmt-ipv4: 172.20.20.101
      exec:
       - ip addr add 192.168.1.10/24 dev eth1
       - ip route del default dev eth0
       - ip route add default via 192.168.1.1
      

  links:
    # -----------------------------------------------
    # CONEXIONES UNDERLAY (REDES WAN/INTERNET)
    # -----------------------------------------------
    
    # Sucursal: Conexiones a los ISPs
    - endpoints: ["fgt-branch:eth1", "isp1:eth1"]  # Enlace Principal (Fibra)
    - endpoints: ["fgt-branch:eth2", "isp2:eth1"]  # Enlace de Backup (4G/5G)

    # Data Center: Conexión a los ISPs
    - endpoints: ["fgt-datacenter:eth1", "isp1:eth2"]
    - endpoints: ["fgt-datacenter:eth2", "isp2:eth2"]  # Enlace de Backup (4G/5G)

    # -----------------------------------------------
    # CONEXIONES OVERLAY (REDES LAN PRIVADAS)
    # -----------------------------------------------
    
    # Red LAN de la Sucursal
    - endpoints: ["fgt-branch:eth3", "pc-branch:eth1"]

    # Red LAN del Data Center
    - endpoints: ["fgt-datacenter:eth3", "server-dc:eth1"]
